# PPAP プロジェクト改善計画

## 調査サマリー

3つの観点（テスト、コード品質、アーキテクチャ）から調査を実施。以下に改善点を優先度別に整理。

---

## 1. テスト改善 (最重要)

### 現状

| カテゴリ       | カバレッジ   | 状態         |
| -------------- | ------------ | ------------ |
| バックエンド   | ~55%         | 部分的       |
| フロントエンド | **0%**       | 完全未テスト |
| E2E            | 基本機能のみ | 部分的       |

### 改善項目

#### 🔴 HIGH: セキュリティ・データ整合性テスト

- [ ] `backend/validate.ts` - XSS対策 (`sanitize()`) のテスト追加
- [ ] 不正ペイロード（超長入力、不正JSON）のテスト
- [ ] WebSocketマルチコネクション競合テスト
- [ ] トークン管理テスト（存在しないトークン、重複など）

#### 🟡 MEDIUM: フロントエンドテスト新規作成

- [ ] `src/composables/store.ts` - 状態管理のユニットテスト
- [ ] `src/composables/webSocket.ts` - 再接続・ハートビートのテスト
- [ ] `src/fetchApi.ts` - エラーハンドリングのテスト
- [ ] `wsMsg/msgFromClient.ts` - 型ガード関数のテスト

#### 🟢 LOW: テストインフラ改善

- [ ] `deno.json` にテストタスク追加:
  ```json
  "test": "deno test --allow-net --allow-read --allow-env backend/",
  "test:coverage": "deno test --coverage=./coverage backend/"
  ```

---

## 2. リファクタリング

### 🔴 HIGH: 即座に対応

#### 2.1 URLルーティング統一

**ファイル**: `backend/server.ts:24-50`

- 同じURLパターンマッチングが4回繰り返されている
- ヘルパー関数に抽出

#### 2.2 JSONパース統一

**ファイル**: `backend/handlers/roomHandlers.ts:22-32, 87-102, 164-174, 198-209`

- 4つのハンドラーで同じtry-catchパターン
- `parseJsonBody<T>(req: Request)` 関数作成

#### 2.3 エラーハンドリング改善

**ファイル**: `backend/handlers/wsHandlers.ts:194, 222`、`src/composables/webSocket.ts:25-27`

- サイレント catch (`catch (_e) {}`) を排除
- 最低限のログ出力追加

#### 2.4 型安全性強化

**ファイル**: 複数

- `as any` / `as unknown` を排除
- `wsMsg/msgFromClient.ts:29-30` - Zod型ガードに移行検討

### 🟡 MEDIUM: 推奨

#### 2.5 wsHandlers.ts 責務分離

**ファイル**: `backend/handlers/wsHandlers.ts` (170行、責務過多)

- メッセージタイプ別にハンドラー分離
- `SocketManager` クラス抽出
- `DisconnectTimerManager` クラス抽出

#### 2.6 Room更新パターン統一

- `updateParticipant(kv, roomId, userToken, updater)` ヘルパー作成
- Room取得→参加者検索→更新→保存をカプセル化

#### 2.7 APIエンドポイント統一

**ファイル**: `src/components/Room.vue:103-107`

- `leaveRoomApi()` を `fetchApi.ts` に追加

---

## 3. セキュリティ改善

### 🔴 HIGH

#### 3.1 CSRF対策追加

**ファイル**: `backend/server.ts`

- Origin検証を追加

```typescript
const origin = request.headers.get("origin")
if (!isAllowedOrigin(origin)) {
  return new Response("Forbidden", { status: 403 })
}
```

#### 3.2 トークンTTL導入

- ユーザートークンに有効期限設定
- Deno KV の `expireIn` オプション活用

### 🟡 MEDIUM

#### 3.3 入力バリデーション強化

- sessionStorageからの値も検証
- フロントエンドでの追加バリデーション

---

## 4. パフォーマンス・スケーラビリティ

### 🟡 MEDIUM

#### 4.1 メモリリーク対策

**ファイル**: `backend/handlers/wsHandlers.ts:6-8`

- グローバルMapのガベージコレクション機構
- 古いルームの自動削除

#### 4.2 KV Watch最適化

- ソケット数0でwatcherを停止
- 不要なwatcher削除

#### 4.3 データ競合対策

- atomic操作のリトライロジック追加
- 並行メッセージ処理の順序保証

---

## 5. 設定・インフラ

### 🟢 LOW

#### 5.1 Viteビルド最適化

**ファイル**: `vite.config.mts`

- チャンク分割設定追加
- ソースマップ設定

#### 5.2 依存関係更新

- Zod: v3.22.4 → v3.23+
- Deno std: 0.209.0 → 最新版

#### 5.3 Permission最小化

**ファイル**: `deno.json`

- `--allow-net=0.0.0.0:8000` など具体的な指定

---

## 実装優先順位

### Phase 1 (1週目): セキュリティ・安定性

1. セキュリティテスト追加
2. CSRF対策
3. エラーハンドリング改善
4. サイレントcatch排除

### Phase 2 (2-3週目): テストカバレッジ

1. フロントエンドユニットテスト作成
2. バリデーションテスト追加
3. deno.jsonテストタスク追加

### Phase 3 (4週目以降): リファクタリング

1. wsHandlers.ts責務分離
2. 共通関数抽出（JSONパース、URL解析）
3. Room更新パターン統一

### Phase 4 (継続的): 最適化

1. メモリリーク対策
2. KV Watch最適化
3. ビルド設定改善

---

## 検証方法

### テスト実行

```bash
# バックエンドテスト
deno test backend/

# 特定ファイル
deno test backend/handlers/roomHandlers_test.ts

# E2Eテスト（サーバー起動必須）
deno task dev:serve &
deno test e2e/
```

### 動作確認

1. `deno task dev` でフロントエンド起動
2. `deno task dev:serve` でバックエンド起動
3. ブラウザで http://localhost:5173 にアクセス
4. ルーム作成→参加→投票の一連フローを確認
