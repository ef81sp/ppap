# バックエンド開発 ToDo リスト

## フェーズ 1: 基盤・データモデル実装

### 1. プロジェクト初期設定

- [x] Deno KV 接続の設定
- [ ] 環境変数設定（開発・本番環境）
- [ ] ログ設定の実装
- [ ] 基本的なエラーハンドリング構造の作成

### 2. データモデル・型定義

- [x] KVS データ構造の型定義
  - [x] Room 型の詳細実装
  - [x] UserToken 関連の型定義
  - [x] API リクエスト・レスポンスの型定義
- [x] 既存`backend/type.ts`との整合性確認・修正
- [x] バリデーション用スキーマの定義

### 3. KVS 基本操作

- [x] ルーム情報の CRUD 操作実装
  - [x] ルーム作成（atomic 操作）
  - [x] ルーム取得
  - [x] ルーム更新（参加者追加/削除、回答更新）
  - [x] ルーム削除
- [x] UserToken 管理機能
  - [x] UserToken 生成
  - [x] UserToken 検証
  - [x] user_tokens 管理（独立キーか rooms 内管理かの決定）
- [x] アトミック操作の実装とテスト

## フェーズ 2: REST API 実装

### 4. ルーム作成 API

- [x] `POST /api/rooms` エンドポイント実装
  - [x] リクエストボディ解析・バリデーション
  - [x] roomId 生成（UUID v4）
  - [x] UserToken 生成
  - [x] 初期ルーム情報を KV に保存
  - [x] レスポンス返却
- [x] エラーハンドリング（400, 500）

### 5. ルーム参加 API

- [x] `POST /api/rooms/:roomId/join` エンドポイント実装
  - [x] リクエストパラメータ・ボディ解析
  - [x] ルーム存在確認
  - [x] UserToken 検証（既存の場合）
  - [x] 新規 UserToken 発行（必要な場合）
  - [x] 参加者情報の追加・更新（atomic 操作）
  - [x] レスポンス返却
- [x] エラーハンドリング（400, 404, 500）

### 6. ルーム退出 API

- [x] `POST /api/rooms/:roomId/leave` エンドポイント実装
  - [x] リクエストボディ解析・バリデーション
  - [x] UserToken 検証
  - [x] 参加者情報の削除（atomic 操作）
  - [ ] WebSocket 接続の切断処理
  - [x] レスポンス返却
- [x] navigator.sendBeacon()対応の確認

## フェーズ 3: WebSocket 実装

### 7. WebSocket 接続処理

- [x] `/ws/rooms/:roomId` エンドポイント実装
  - [x] クエリパラメータから UserToken 取得・検証
  - [x] ルーム存在確認
  - [x] WebSocket 接続確立
  - [x] 接続管理（UserToken <-> WebSocket のマッピング）

### 8. WebSocket メッセージハンドリング

- [x] クライアントからのメッセージ解析
  - [x] `submit_answer` メッセージ処理（雛形）
  - [x] `toggle_spectator` メッセージ処理（雛形）
  - [x] `clear_answers` メッセージ処理（雛形）
- [x] メッセージバリデーション（雛形）
- [x] 不正メッセージの対応（雛形）

### 9. WebSocket 通知機能

- [x] サーバーからクライアントへの通知実装
  - [x] `room_update` メッセージ送信（雛形）
  - [x] `error` メッセージ送信（雛形）
- [x] 複数クライアントへのブロードキャスト機能（雛形）

## フェーズ 4: リアルタイム機能・KV 監視

### 10. Deno KV Watch 実装

- [x] ルーム情報変更の監視設定（雛形）
- [x] watch イベントハンドリング（雛形）
- [x] 変更検知時の WebSocket クライアント通知（雛形）
- [ ] 複数インスタンス対応の考慮

### 11. 回答機能

- [x] 回答送信処理の実装
  - [x] KVS 回答データ更新（atomic 操作）
  - [x] updatedAt 更新
  - [x] 他参加者への通知
- [x] 回答クリア機能
  - [x] 全回答削除処理（atomic 操作）
  - [x] 全参加者への通知

### 12. 観覧者モード

- [x] 観覧者モード切替処理
  - [x] isSpectator フラグ更新（atomic 操作）
  - [x] 参加者リスト更新通知（watch 経由）

## フェーズ 5: セキュリティ・品質向上

### 13. セキュリティ対策

- [x] 入力値バリデーション強化
  - [x] ルーム名、ユーザー名、回答内容のサニタイズ
  - [x] 文字数制限の実装
- [x] WebSocket セキュリティ
  - [x] Origin ヘッダー検証
  - [x] メッセージサイズ・頻度制限
- [x] エラーメッセージの機密情報除去

### 14. エラーハンドリング・ログ

- [ ] 包括的なエラーハンドリング
  - [ ] KV 操作エラーの詳細対応
  - [ ] WebSocket 接続エラーの対応
  - [ ] 書き込み競合の対応
- [ ] ログ機能の充実
  - [ ] 重要な処理のログ記録
  - [ ] エラーログの詳細化
  - [ ] Deno Deploy ログ機能活用

### 15. 自動退出・クリーンアップ

- [ ] タイムアウト処理
  - [ ] 長時間非アクティブユーザーの自動退出
  - [ ] lastAccessedAt 更新処理
- [ ] TTL 設定・データクリーンアップ
  - [ ] 古いルーム情報の自動削除
  - [ ] 使用されていない UserToken の削除

## フェーズ 6: テスト・最適化

### 16. テスト実装

- [ ] ローカル KV を使用した結合テスト
  - [ ] ルーム作成〜参加〜退出の一連フロー
  - [ ] WebSocket 通信テスト
  - [ ] KV データの直接検証
- [ ] 単体テスト（必要に応じて）
  - [ ] データモデル操作のテスト
  - [ ] バリデーション機能のテスト

### 17. パフォーマンス・運用対応

- [ ] 複数インスタンス対応の詳細検討
  - [ ] Deno Queues 利用の検討・実装
  - [ ] クライアント側ポーリングのフォールバック
- [ ] 負荷テスト
- [ ] 監視・メトリクス設定

## フェーズ 7: 統合・デプロイ準備

### 18. フロントエンド統合

- [ ] API エンドポイントの動作確認
- [ ] WebSocket 通信の動作確認
- [ ] エラー処理の統合テスト

### 19. Deno Deploy 対応

- [ ] デプロイ設定の確認
- [ ] 本番環境での動作テスト
- [ ] 環境変数設定

---

## 実装の優先順位

**高優先度（MVP 必須）:**

- フェーズ 1-3: 基本的なルーム作成・参加・WebSocket 通信
- フェーズ 4 の基本的なリアルタイム機能

**中優先度（品質向上）:**

- フェーズ 5: セキュリティ・エラーハンドリング
- フェーズ 6: テスト

**低優先度（将来的な改善）:**

- 複数インスタンス対応の高度な機能
- パフォーマンス最適化

## 注意事項

- 各フェーズの実装中に設計書の不足情報・検討事項を随時決定する
- ユーザー名重複の扱い、user_tokens 管理方法などは実装中に確定
- テストは実装と並行して進める
- 技術的制約（複数インスタンス問題）は初期は watch()のみで開始し、必要に応じて Deno Queues
  対応を検討
