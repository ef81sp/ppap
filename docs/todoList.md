# バックエンド開発 ToDoリスト

## フェーズ1: 基盤・データモデル実装

### 1. プロジェクト初期設定
- [ ] Deno KV接続の設定
- [ ] 環境変数設定（開発・本番環境）
- [ ] ログ設定の実装
- [ ] 基本的なエラーハンドリング構造の作成

### 2. データモデル・型定義
- [ ] KVSデータ構造の型定義
  - [ ] Room型の詳細実装
  - [ ] UserToken関連の型定義
  - [ ] APIリクエスト・レスポンスの型定義
- [ ] 既存`backend/type.ts`との整合性確認・修正
- [ ] バリデーション用スキーマの定義

### 3. KVS基本操作
- [ ] ルーム情報のCRUD操作実装
  - [ ] ルーム作成（atomic操作）
  - [ ] ルーム取得
  - [ ] ルーム更新（参加者追加/削除、回答更新）
  - [ ] ルーム削除
- [ ] UserToken管理機能
  - [ ] UserToken生成
  - [ ] UserToken検証
  - [ ] user_tokens管理（独立キーかrooms内管理かの決定）
- [ ] アトミック操作の実装とテスト

## フェーズ2: REST API実装

### 4. ルーム作成API
- [ ] `POST /api/rooms` エンドポイント実装
  - [ ] リクエストボディ解析・バリデーション
  - [ ] roomId生成（UUID v4）
  - [ ] UserToken生成
  - [ ] 初期ルーム情報をKVに保存
  - [ ] レスポンス返却
- [ ] エラーハンドリング（400, 500）

### 5. ルーム参加API
- [ ] `POST /api/rooms/:roomId/join` エンドポイント実装
  - [ ] リクエストパラメータ・ボディ解析
  - [ ] ルーム存在確認
  - [ ] UserToken検証（既存の場合）
  - [ ] 新規UserToken発行（必要な場合）
  - [ ] 参加者情報の追加・更新（atomic操作）
  - [ ] レスポンス返却
- [ ] エラーハンドリング（400, 404, 500）

### 6. ルーム退出API
- [ ] `POST /api/rooms/:roomId/leave` エンドポイント実装
  - [ ] リクエストボディ解析・バリデーション
  - [ ] UserToken検証
  - [ ] 参加者情報の削除（atomic操作）
  - [ ] WebSocket接続の切断処理
  - [ ] レスポンス返却
- [ ] navigator.sendBeacon()対応の確認

## フェーズ3: WebSocket実装

### 7. WebSocket接続処理
- [ ] `/ws/rooms/:roomId` エンドポイント実装
  - [ ] クエリパラメータからUserToken取得・検証
  - [ ] ルーム存在確認
  - [ ] WebSocket接続確立
  - [ ] 接続管理（UserToken <-> WebSocket のマッピング）

### 8. WebSocketメッセージハンドリング
- [ ] クライアントからのメッセージ解析
  - [ ] `submit_answer` メッセージ処理
  - [ ] `toggle_spectator` メッセージ処理
  - [ ] `clear_answers` メッセージ処理
- [ ] メッセージバリデーション
- [ ] 不正メッセージの対応

### 9. WebSocket通知機能
- [ ] サーバーからクライアントへの通知実装
  - [ ] `room_update` メッセージ送信
  - [ ] `error` メッセージ送信
- [ ] 複数クライアントへのブロードキャスト機能

## フェーズ4: リアルタイム機能・KV監視

### 10. Deno KV Watch実装
- [ ] ルーム情報変更の監視設定
- [ ] watch イベントハンドリング
- [ ] 変更検知時のWebSocketクライアント通知
- [ ] 複数インスタンス対応の考慮

### 11. 回答機能
- [ ] 回答送信処理の実装
  - [ ] KVS回答データ更新（atomic操作）
  - [ ] updatedAt更新
  - [ ] 他参加者への通知
- [ ] 回答クリア機能
  - [ ] 全回答削除処理（atomic操作）
  - [ ] 全参加者への通知

### 12. 観覧者モード
- [ ] 観覧者モード切替処理
  - [ ] isSpectatorフラグ更新（atomic操作）
  - [ ] 参加者リスト更新通知

## フェーズ5: セキュリティ・品質向上

### 13. セキュリティ対策
- [ ] 入力値バリデーション強化
  - [ ] ルーム名、ユーザー名、回答内容のサニタイズ
  - [ ] 文字数制限の実装
- [ ] WebSocketセキュリティ
  - [ ] Originヘッダー検証
  - [ ] メッセージサイズ・頻度制限
- [ ] エラーメッセージの機密情報除去

### 14. エラーハンドリング・ログ
- [ ] 包括的なエラーハンドリング
  - [ ] KV操作エラーの詳細対応
  - [ ] WebSocket接続エラーの対応
  - [ ] 書き込み競合の対応
- [ ] ログ機能の充実
  - [ ] 重要な処理のログ記録
  - [ ] エラーログの詳細化
  - [ ] Deno Deployログ機能活用

### 15. 自動退出・クリーンアップ
- [ ] タイムアウト処理
  - [ ] 長時間非アクティブユーザーの自動退出
  - [ ] lastAccessedAt更新処理
- [ ] TTL設定・データクリーンアップ
  - [ ] 古いルーム情報の自動削除
  - [ ] 使用されていないUserTokenの削除

## フェーズ6: テスト・最適化

### 16. テスト実装
- [ ] ローカルKVを使用した結合テスト
  - [ ] ルーム作成〜参加〜退出の一連フロー
  - [ ] WebSocket通信テスト
  - [ ] KVデータの直接検証
- [ ] 単体テスト（必要に応じて）
  - [ ] データモデル操作のテスト
  - [ ] バリデーション機能のテスト

### 17. パフォーマンス・運用対応
- [ ] 複数インスタンス対応の詳細検討
  - [ ] Deno Queues利用の検討・実装
  - [ ] クライアント側ポーリングのフォールバック
- [ ] 負荷テスト
- [ ] 監視・メトリクス設定

## フェーズ7: 統合・デプロイ準備

### 18. フロントエンド統合
- [ ] APIエンドポイントの動作確認
- [ ] WebSocket通信の動作確認
- [ ] エラー処理の統合テスト

### 19. Deno Deploy対応
- [ ] デプロイ設定の確認
- [ ] 本番環境での動作テスト
- [ ] 環境変数設定

---

## 実装の優先順位

**高優先度（MVP必須）:**
- フェーズ1-3: 基本的なルーム作成・参加・WebSocket通信
- フェーズ4の基本的なリアルタイム機能

**中優先度（品質向上）:**
- フェーズ5: セキュリティ・エラーハンドリング
- フェーズ6: テスト

**低優先度（将来的な改善）:**
- 複数インスタンス対応の高度な機能
- パフォーマンス最適化

## 注意事項

- 各フェーズの実装中に設計書の不足情報・検討事項を随時決定する
- ユーザー名重複の扱い、user_tokens管理方法などは実装中に確定
- テストは実装と並行して進める
- 技術的制約（複数インスタンス問題）は初期はwatch()のみで開始し、必要に応じてDeno Queues対応を検討